function [Szz_grid, k_grid, omega_grid] = zz_spectrum(L, h, lambda, omega, r)

% calculate zz spectrum
% S(k, omega) = sum_i C_i delta(omega - omega_i)

k = pi*linspace(-(L-1)/L, (L-1)/L, L);
[C, delta] = deal(zeros(L, L));

[Costheta, Sintheta, epsilon] = k2theta(k, h, lambda);

for i = 1:L
    idx = mod((0:L - 1) + i - 1, L) + 1;
    
    delta(i, :) = epsilon + epsilon(idx);
    
    C(i, :) = 4*pi/L*(Sintheta.*Costheta(idx) + Costheta.*Sintheta(idx)).^2;
    
end

k_grid = repmat(pi*linspace(1/L, (2*L - 1)/L, L).', [1, numel(omega)]);

omega = reshape(omega, [1, numel(omega)]);
omega_grid = repmat(omega, [L, 1]);
Szz_grid = zeros(size(k_grid));

% convolution function
f_c = @(x) normpdf(x, 0, r);

for i = 1:L
    Szz_grid(i, :) = sum(C(i, :).'.*f_c(delta(i, :).' - omega), 1);
end

omega_grid = omega_grid/4;
% surf(k_grid/pi, omega_grid, Szz_grid, 'EdgeColor', 'none');
% xlabel('k/\pi');
% ylabel('\omega');
% colorbar;
% view(2);
% colormap(jet(256));
% set(gca, 'Colormap',...
%     [0 0 0.515625;0 0 0.53076171875;0 0 0.5458984375;0 0 0.56103515625;0 0 0.576171875;0 0 0.59130859375;0 0 0.6064453125;0 0 0.62158203125;0 0 0.63671875;0 0 0.65185546875;0 0 0.6669921875;0 0 0.68212890625;0 0 0.697265625;0 0 0.71240234375;0 0 0.7275390625;0 0 0.74267578125;0 0 0.7578125;0 0 0.77294921875;0 0 0.7880859375;0 0 0.80322265625;0 0 0.818359375;0 0 0.83349609375;0 0 0.8486328125;0 0 0.86376953125;0 0 0.87890625;0 0 0.89404296875;0 0 0.9091796875;0 0 0.92431640625;0 0 0.939453125;0 0 0.95458984375;0 0 0.9697265625;0 0 0.98486328125;0 0 1;0 0.015625 1;0 0.03125 1;0 0.046875 1;0 0.0625 1;0 0.078125 1;0 0.09375 1;0 0.109375 1;0 0.125 1;0 0.140625 1;0 0.15625 1;0 0.171875 1;0 0.1875 1;0 0.203125 1;0 0.21875 1;0 0.234375 1;0 0.25 1;0 0.265625 1;0 0.28125 1;0 0.296875 1;0 0.3125 1;0 0.328125 1;0 0.34375 1;0 0.359375 1;0 0.375 1;0 0.390625 1;0 0.40625 1;0 0.421875 1;0 0.4375 1;0 0.453125 1;0 0.46875 1;0 0.484375 1;0 0.5 1;0 0.515625 1;0 0.53125 1;0 0.546875 1;0 0.5625 1;0 0.578125 1;0 0.59375 1;0 0.609375 1;0 0.625 1;0 0.640625 1;0 0.65625 1;0 0.671875 1;0 0.6875 1;0 0.703125 1;0 0.71875 1;0 0.734375 1;0 0.75 1;0 0.765625 1;0 0.78125 1;0 0.796875 1;0 0.8125 1;0 0.828125 1;0 0.84375 1;0 0.859375 1;0 0.875 1;0 0.890625 1;0 0.90625 1;0 0.921875 1;0 0.9375 1;0 0.953125 1;0 0.96875 1;0 0.984375 1;0 1 1;0.015625 1 0.984375;0.03125 1 0.96875;0.046875 1 0.953125;0.0625 1 0.9375;0.078125 1 0.921875;0.09375 1 0.90625;0.109375 1 0.890625;0.125 1 0.875;0.140625 1 0.859375;0.15625 1 0.84375;0.171875 1 0.828125;0.1875 1 0.8125;0.203125 1 0.796875;0.21875 1 0.78125;0.234375 1 0.765625;0.25 1 0.75;0.265625 1 0.734375;0.28125 1 0.71875;0.296875 1 0.703125;0.3125 1 0.6875;0.328125 1 0.671875;0.34375 1 0.65625;0.359375 1 0.640625;0.375 1 0.625;0.390625 1 0.609375;0.40625 1 0.59375;0.421875 1 0.578125;0.4375 1 0.5625;0.453125 1 0.546875;0.46875 1 0.53125;0.484375 1 0.515625;0.5 1 0.5;0.515625 1 0.484375;0.53125 1 0.46875;0.546875 1 0.453125;0.5625 1 0.4375;0.578125 1 0.421875;0.59375 1 0.40625;0.609375 1 0.390625;0.625 1 0.375;0.640625 1 0.359375;0.65625 1 0.34375;0.671875 1 0.328125;0.6875 1 0.3125;0.703125 1 0.296875;0.71875 1 0.28125;0.734375 1 0.265625;0.75 1 0.25;0.765625 1 0.234375;0.78125 1 0.21875;0.796875 1 0.203125;0.8125 1 0.1875;0.828125 1 0.171875;0.84375 1 0.15625;0.859375 1 0.140625;0.875 1 0.125;0.890625 1 0.109375;0.90625 1 0.09375;0.921875 1 0.078125;0.9375 1 0.0625;0.953125 1 0.046875;0.96875 1 0.03125;0.984375 1 0.015625;1 1 0;1 0.984375 0;1 0.96875 0;1 0.953125 0;1 0.9375 0;1 0.921875 0;1 0.90625 0;1 0.890625 0;1 0.875 0;1 0.859375 0;1 0.84375 0;1 0.828125 0;1 0.8125 0;1 0.796875 0;1 0.78125 0;1 0.765625 0;1 0.75 0;1 0.734375 0;1 0.71875 0;1 0.703125 0;1 0.6875 0;1 0.671875 0;1 0.65625 0;1 0.640625 0;1 0.625 0;1 0.609375 0;1 0.59375 0;1 0.578125 0;1 0.5625 0;1 0.546875 0;1 0.53125 0;1 0.515625 0;1 0.5 0;1 0.484375 0;1 0.46875 0;1 0.453125 0;1 0.4375 0;1 0.421875 0;1 0.40625 0;1 0.390625 0;1 0.375 0;1 0.359375 0;1 0.34375 0;1 0.328125 0;1 0.3125 0;1 0.296875 0;1 0.28125 0;1 0.265625 0;1 0.25 0;1 0.234375 0;1 0.21875 0;1 0.203125 0;1 0.1875 0;1 0.171875 0;1 0.15625 0;1 0.140625 0;1 0.125 0;1 0.109375 0;1 0.09375 0;1 0.078125 0;1 0.0625 0;1 0.046875 0;1 0.03125 0;1 0.015625 0;1 0 0;0.983870983123779 0 0;0.967741906642914 0 0;0.951612889766693 0 0;0.935483872890472 0 0;0.919354856014252 0 0;0.903225779533386 0 0;0.887096762657166 0 0;0.870967745780945 0 0;0.854838728904724 0 0;0.838709652423859 0 0;0.822580635547638 0 0;0.806451618671417 0 0;0.790322601795197 0 0;0.774193525314331 0 0;0.75806450843811 0 0;0.74193549156189 0 0;0.725806474685669 0 0;0.709677398204803 0 0;0.693548381328583 0 0;0.677419364452362 0 0;0.661290347576141 0 0;0.645161271095276 0 0;0.629032254219055 0 0;0.612903237342834 0 0;0.596774220466614 0 0;0.580645143985748 0 0;0.564516127109528 0 0;0.548387110233307 0 0;0.532258093357086 0 0;0.516129016876221 0 0;0.5 0 0]);
%     
% set(gca, 'fontsize', 18, 'linewidth', 2,'fontname','Times New Roman','box','on');
% set(gca, 'Position',[0.2 0.2 0.6 0.6])
% set(gcf,'position',[800, 800, 400, 400]);

end

function [Costheta, Sintheta, epsilon] = k2theta(k, h, lambda)

% calculate cos(theta_k) and sin(theta_k) used for diagonalize BdG H

if lambda == 1
    lambda = lambda + 1e-8;
end

    Tantheta = (h - cos(k) - lambda*cos(k) + (h^2 - 2*cos(k)*h*lambda - 2*cos(k)*h + lambda^2 + 2*cos(2*k)*lambda + 1).^(1/2))./(sin(k)*(lambda - 1));
    Sintheta = Tantheta./sqrt(Tantheta.^2 + 1);
    Costheta = sqrt(1 - Sintheta.^2);


epsilon =  2*(h^2 - 2*h*cos(k) - 2*lambda + lambda^2 + 4*lambda*cos(k).^2 - 2*h*lambda*cos(k) + 1).^(1/2);


end
